# RepVGG å›¾åƒåˆ†ç±»æ¨¡å‹è®­ç»ƒéƒ¨ç½²ç®€å•æµç¨‹ ğŸš€

æœ¬é¡¹ç›®ä»¥ [RepVGG](https://github.com/DingXiaoH/RepVGG) ä¸ºæ ¸å¿ƒï¼Œç®€åŒ–äº†**æ¨¡å‹è®­ç»ƒã€éªŒè¯ã€æ¨ç†ã€æƒé‡è½¬æ¢ã€ONNX å¯¼å‡ºã€C++é«˜æ•ˆéƒ¨ç½²**ç­‰æµç¨‹ï¼Œé€‚åˆæ·±åº¦å­¦ä¹ å…¥é—¨ä¸ç®€å•å·¥ç¨‹å®è·µã€‚

---

## ç›®å½•

- [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
- [Python ç«¯å…¸å‹å‘½ä»¤ä¸è¯´æ˜](#python-ç«¯å…¸å‹å‘½ä»¤ä¸è¯´æ˜)
- [C++ ç«¯å…¸å‹å‘½ä»¤ä¸è¯´æ˜](#c-ç«¯å…¸å‹å‘½ä»¤ä¸è¯´æ˜)
- [C++ ä¾èµ–å®‰è£…ä¸ç¯å¢ƒé…ç½®](#c-ä¾èµ–å®‰è£…ä¸ç¯å¢ƒé…ç½®)
- [Python & C++ é€Ÿåº¦å¯¹æ¯”](#python--c-é€Ÿåº¦å¯¹æ¯”)
- [VGGå®¶æ—ä¸RepVGGæ¨¡å‹åŸç†è¯¦è§£](#vggå®¶æ—ä¸repvggæ¨¡å‹åŸç†è¯¦è§£)
- [ç»“æ„é‡å‚æ•°åŒ–å®‡å®™ç®€è¿°](#ç»“æ„é‡å‚æ•°åŒ–å®‡å®™ç®€è¿°)

---

## ç¯å¢ƒå‡†å¤‡ ğŸ› ï¸

### 1. åˆ›å»º conda ç¯å¢ƒ
```bash
conda create -n repvgg python=3.9 -y
conda activate repvgg
```

### 2. å®‰è£… Python ä¾èµ–
```bash
# è®­ç»ƒæˆ–è€…æ¨ç†éªŒè¯è¿‡ç¨‹ä¸­ï¼Œç¼ºå•¥åŒ…ï¼Œç”¨pipè£…å•¥åŒ…å°±è¡Œ
pip install torch torchvision opencv-python onnx onnxruntime onnxsim tqdm
```

---

## Python ç«¯å…¸å‹å‘½ä»¤ä¸è¯´æ˜

> **æ³¨æ„ï¼šæ‰€æœ‰æƒé‡æ–‡ä»¶è·¯å¾„ã€æ•°æ®é›†è·¯å¾„è¯·æ ¹æ®ä½ æœ¬åœ°å®é™…æƒ…å†µä¿®æ”¹ï¼**

### 1. è®­ç»ƒï¼ˆæŒ‡å®šImageNeté¢„è®­ç»ƒæƒé‡ï¼‰
```bash
python main.py --mode train --pretrained_path "/Users/yuansu/Code/repvgg_classification/pretrained/RepVGG-A0-train.pth"

# æ•°æ®é›†ä¸‹è½½ä¸ç›®å½•ç»“æ„è¯´æ˜
# æ•°æ®é›†ä¸‹è½½åœ°å€ï¼š[çŒ«ç‹—è¯†åˆ«æ•°æ®é›†ï¼ˆModelScopeï¼‰](https://www.modelscope.cn/datasets/tany0699/cats_and_dogs)

# è§£å‹åç›®å½•ç»“æ„å¦‚ä¸‹ï¼š
# cats_and_dogs/
#   â”œâ”€â”€ train/
#   â”‚   â”œâ”€â”€ cat/
#   â”‚   â””â”€â”€ dog/
#   â””â”€â”€ val/
#       â”œâ”€â”€ cat/
#       â””â”€â”€ dog/
```
- `--pretrained_path` æŒ‡å®šImageNeté¢„è®­ç»ƒæƒé‡è·¯å¾„ã€‚

### 2. æ¨ç†ï¼ˆè®­ç»ƒæƒé‡ï¼‰
```bash
python main.py --mode "inference" --input "/Users/yuansu/Desktop/codes/datasets/cats_and_dogs/val/cat"
```
- `--input` å¯ä¸ºå•å¼ å›¾ç‰‡æˆ–æ–‡ä»¶å¤¹ã€‚
- é»˜è®¤ä½¿ç”¨config.pyä¸­æŒ‡å®šçš„è®­ç»ƒæƒé‡ã€‚

### 3. æƒé‡è½¬æ¢ï¼ˆè®­ç»ƒæƒé‡â†’éƒ¨ç½²æƒé‡ï¼‰
```bash
python convert.py --model "RepVGG-A0" --input "/Users/yuansu/Code/repvgg_classification/checkpoints/RepVGG-A0_1/RepVGG-A0_4/best.pth"
```
- `--input` ä¸ºè®­ç»ƒå¾—åˆ°çš„best.pthã€‚
- `--output` å¯çœç•¥ï¼Œé»˜è®¤ä¸è¾“å…¥åŒç›®å½•ã€‚

### 4. ä½¿ç”¨é‡å‚æ•°åŒ–æƒé‡æ¨ç†
```bash
python main.py --mode "inference" --input "/Users/yuansu/Desktop/codes/datasets/cats_and_dogs/val/dog" --checkpoint_path "/Users/yuansu/Code/repvgg_classification/checkpoints/RepVGG-A0_1/RepVGG-A0_4/deploy.pth" --deploy True
```
- `--checkpoint_path` æŒ‡å®šdeploy.pthã€‚
- `--deploy True` è¡¨ç¤ºæ¨ç†ç»“æ„ã€‚

### 5. Pythonä¸‹è½¬æ¢å‰åæ¨ç†é€Ÿåº¦å¯¹æ¯”
```bash
python benchmark.py --model RepVGG-A0 --train_weights /Users/yuansu/Code/repvgg_classification/checkpoints/RepVGG-A0_1/RepVGG-A0_4/best.pth --deploy_weights /Users/yuansu/Code/repvgg_classification/checkpoints/RepVGG-A0_1/RepVGG-A0_4/deploy.pth --num_classes 2
```
- å¯¹æ¯”è®­ç»ƒç»“æ„å’Œdeployç»“æ„çš„æ¨ç†é€Ÿåº¦ã€‚

### 6. å¯¼å‡ºONNXæƒé‡
```bash
python export_onnx.py --weights /Users/yuansu/Code/repvgg_classification/checkpoints/RepVGG-A0_1/RepVGG-A0_4/deploy.pth --model "RepVGG-A0"
```
- `--weights` æŒ‡deploy.pthã€‚
- `--output` å¯çœç•¥ï¼Œé»˜è®¤åŒç›®å½•ã€‚

---

## C++ ç«¯å…¸å‹å‘½ä»¤ä¸è¯´æ˜

> **æ³¨æ„ï¼šC++æ¨ç†å’Œbenchmarkå‘½ä»¤ä¸­çš„ONNXæƒé‡è·¯å¾„ã€å›¾ç‰‡è·¯å¾„ç­‰ä¹Ÿéœ€æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼**

### 1. æ¨ç†ï¼ˆç¼–è¯‘åå¯æ‰§è¡Œæ–‡ä»¶ï¼‰
```bash
./repvgg_inference /Users/yuansu/Code/repvgg_classification/cpp_inference/checkpoints/deploy.onnx /Users/yuansu/Desktop/codes/datasets/cats_and_dogs/val/dog 224
```
- ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºONNXæ¨¡å‹è·¯å¾„ï¼Œç¬¬äºŒä¸ªä¸ºå›¾ç‰‡æˆ–æ–‡ä»¶å¤¹è·¯å¾„ï¼Œç¬¬ä¸‰ä¸ªä¸ºå›¾ç‰‡å°ºå¯¸ã€‚

### 2. C++ç‰ˆæœ¬é€Ÿåº¦æµ‹è¯•
```bash
./benchmark_onnx /Users/yuansu/Code/repvgg_classification/cpp_inference/checkpoints/deploy.onnx 224 100 500
```
- 100ä¸ºé¢„çƒ­æ¬¡æ•°ï¼Œ500ä¸ºæµ‹è¯•æ¬¡æ•°ã€‚

> **æç¤ºï¼šONNXç³»ç»Ÿåº“æŠ¥é”™å¯å¿½ç•¥ï¼Œä¸å½±å“å®é™…æ¨ç†å’Œé€Ÿåº¦æµ‹è¯•ã€‚**

---

## C++ ä¾èµ–å®‰è£…ä¸ç¯å¢ƒé…ç½®

| å¹³å°   | ONNX Runtime å®‰è£…                | OpenCV å®‰è£…                | CMake å®‰è£…                |
|--------|----------------------------------|----------------------------|---------------------------|
| **macOS** | `brew install onnxruntime`        | `brew install opencv`      | `brew install cmake`      |
| **Ubuntu** | `sudo apt update && sudo apt install -y onnxruntime libopencv-dev cmake g++` <br>ï¼ˆå¦‚éœ€æºç ç¼–è¯‘OpenCV/ONNX Runtimeè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼‰ | `sudo apt install libopencv-dev` | `sudo apt install cmake` |

> **æ³¨æ„ï¼š**
> - Ubuntuä¸‹å¦‚éœ€æ›´é«˜æ€§èƒ½ï¼Œå¯ä»[ONNX Runtimeå®˜æ–¹](https://onnxruntime.ai/)æºç ç¼–è¯‘ï¼Œæ”¯æŒOpenMP/MKLç­‰ã€‚
> - OpenCVå»ºè®®ç”¨ç³»ç»ŸåŒ…æˆ–æºç ç¼–è¯‘ï¼Œç¡®ä¿æœ‰C++å¤´æ–‡ä»¶å’ŒåŠ¨æ€åº“ã€‚

---

## Python & C++ é€Ÿåº¦å¯¹æ¯”

| ç‰ˆæœ¬         | å¹³å‡å»¶è¿Ÿ (ms) | ååé‡ (FPS) |
|--------------|--------------|--------------|
| Pythonéƒ¨ç½²ç‰ˆ | 9.54         | 104.85       |
| C++ ONNXç‰ˆ   | 11.85        | 84.39        |

> **è¯´æ˜ï¼š** æŒ‰ç†è¯´ C++ ONNX Runtime æ¨ç†åº”æ›´å¿«ï¼Œä½†æœ¬é¡¹ç›®æµ‹è¯•ä¸­ C++ ç‰ˆæœ¬ç•¥æ…¢ï¼ŒåŸå› å¯èƒ½åŒ…æ‹¬ï¼š
> - ONNX Runtime çº¿ç¨‹æ•°/BLASä¼˜åŒ–æœªå®Œå…¨è°ƒä¼˜
> - Python/PyTorch é»˜è®¤å¤šçº¿ç¨‹ï¼ŒBLASåº“æ›´ä¼˜
> - ONNXæ¨¡å‹ç»“æ„æœªæè‡´ä¼˜åŒ–
> 
> **åç»­å¯è¿›ä¸€æ­¥æµ‹è¯•å’Œä¼˜åŒ–ã€‚**

---

## VGGå®¶æ—ä¸RepVGGæ¨¡å‹åŸç†è¯¦è§£

### 1. VGGç½‘ç»œæ¨ç†åŸç†è¯¦è§£

VGGç½‘ç»œæ˜¯ä¸€ç§å…¸å‹çš„æ·±å±‚å·ç§¯ç¥ç»ç½‘ç»œï¼Œå…¶æ¨ç†æµç¨‹å¦‚ä¸‹ï¼š

1. **å›¾ç‰‡è¾“å…¥**
   - è¾“å…¥ä¸€å¼ RGBå›¾ç‰‡ï¼Œé€šå¸¸ä¼šresizeä¸º224x224åƒç´ ï¼Œå½’ä¸€åŒ–åˆ°[0,1]æˆ–[-1,1]ã€‚

2. **å·ç§¯å±‚ï¼ˆConvï¼‰**
   - å¤šä¸ª3x3å·ç§¯æ ¸æ»‘åŠ¨çª—å£æå–å±€éƒ¨ç‰¹å¾ï¼Œæ¯ä¸ªå·ç§¯æ ¸å¯çœ‹ä½œä¸€ä¸ªç‰¹å¾æ£€æµ‹å™¨ã€‚
   - æ¯ä¸€å±‚å·ç§¯åï¼Œè¾“å‡ºç‰¹å¾å›¾ï¼ˆfeature mapï¼‰ï¼Œé€šé“æ•°é€å±‚å¢åŠ ï¼ˆå¦‚64â†’128â†’256â†’512ï¼‰ã€‚
   - å·ç§¯æ“ä½œæœ¬è´¨ï¼šå¯¹è¾“å…¥çš„æ¯ä¸ªå°åŒºåŸŸä¸å·ç§¯æ ¸åšåŠ æƒæ±‚å’Œï¼Œè¾“å‡ºä¸€ä¸ªæ–°åƒç´ ã€‚

3. **æ¿€æ´»å‡½æ•°ï¼ˆReLUï¼‰**
   - æ¯ä¸ªå·ç§¯å±‚åæ¥ReLUæ¿€æ´»ï¼Œå¢åŠ éçº¿æ€§è¡¨è¾¾èƒ½åŠ›ã€‚
   - å…¬å¼ï¼š`y = max(0, x)`ï¼ŒæŠ‘åˆ¶è´Ÿå€¼ï¼Œä¿ç•™æ­£å€¼ã€‚

4. **æ± åŒ–å±‚ï¼ˆPoolingï¼‰**
   - é€šå¸¸ä¸º2x2æœ€å¤§æ± åŒ–ï¼ˆMaxPoolingï¼‰ï¼Œæ¯2x2åŒºåŸŸå–æœ€å¤§å€¼ï¼Œé™ä½ç©ºé—´åˆ†è¾¨ç‡ï¼Œå‡å°‘å‚æ•°å’Œè®¡ç®—é‡ã€‚
   - æ± åŒ–æœ‰åŠ©äºæå–æ›´å…·é²æ£’æ€§çš„ç‰¹å¾ï¼ŒæŠ‘åˆ¶å™ªå£°ã€‚

5. **å¤šå±‚å·ç§¯+æ± åŒ–å †å **
   - VGG16/19ç­‰ç½‘ç»œä¼šå †å å¤šç»„"å·ç§¯+ReLU+æ± åŒ–"ï¼Œé€æ­¥æå–ä»ä½çº§åˆ°é«˜çº§çš„ç‰¹å¾ã€‚

6. **å±•å¹³ï¼ˆFlattenï¼‰**
   - æœ€åä¸€ä¸ªæ± åŒ–å±‚è¾“å‡ºçš„ç‰¹å¾å›¾å±•å¹³æˆä¸€ç»´å‘é‡ï¼Œä½œä¸ºå…¨è¿æ¥å±‚è¾“å…¥ã€‚

7. **å…¨è¿æ¥å±‚ï¼ˆFCï¼‰**
   - ä¸€èˆ¬æœ‰2-3ä¸ªå…¨è¿æ¥å±‚ï¼Œæ¨¡æ‹Ÿä¼ ç»ŸMLPï¼Œè¿›ä¸€æ­¥èåˆå…¨å±€ç‰¹å¾ã€‚
   - æœ€åä¸€å±‚è¾“å‡ºçš„å‘é‡é•¿åº¦ç­‰äºç±»åˆ«æ•°ï¼ˆå¦‚1000ï¼‰ã€‚

8. **Softmaxè¾“å‡º**
   - å¯¹æœ€åä¸€å±‚è¾“å‡ºåšsoftmaxå½’ä¸€åŒ–ï¼Œå¾—åˆ°æ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚
   - å–æ¦‚ç‡æœ€å¤§è€…ä¸ºæœ€ç»ˆé¢„æµ‹ç±»åˆ«ã€‚

**æ¨ç†æµç¨‹ä¸¾ä¾‹ï¼š**
> ä¸€å¼ çŒ«çš„å›¾ç‰‡è¾“å…¥VGG16ï¼Œç»è¿‡å¤šå±‚å·ç§¯æå–è¾¹ç¼˜ã€çº¹ç†ã€å½¢çŠ¶ç­‰ç‰¹å¾ï¼Œæ± åŒ–é™ç»´ï¼Œå…¨è¿æ¥å±‚èåˆå…¨å±€ä¿¡æ¯ï¼Œsoftmaxè¾“å‡º"cat"ç±»åˆ«æ¦‚ç‡æœ€å¤§ï¼Œæ¨¡å‹æœ€ç»ˆåˆ¤å®šä¸º"cat"ã€‚

---

### 2. RepVGGåŸç†ä¸åˆ›æ–°
- **æ ¸å¿ƒæ€æƒ³**ï¼šè®­ç»ƒæ—¶ç”¨å¤šåˆ†æ”¯ç»“æ„ï¼ˆ3x3å·ç§¯ã€1x1å·ç§¯ã€Identityï¼‰ï¼Œæ¨ç†æ—¶å°†å¤šåˆ†æ”¯ç»“æ„é‡å‚æ•°åŒ–ä¸ºå•ä¸€3x3å·ç§¯ï¼Œå…¼é¡¾è®­ç»ƒæ€§èƒ½å’Œæ¨ç†é€Ÿåº¦ã€‚
- **ç»“æ„é‡å‚æ•°åŒ–**ï¼šè®­ç»ƒæ—¶çš„å¤šåˆ†æ”¯ç»“æ„å¯æå‡è¡¨è¾¾èƒ½åŠ›å’Œæ”¶æ•›é€Ÿåº¦ï¼Œæ¨ç†æ—¶èåˆä¸ºå•åˆ†æ”¯ï¼Œæå¤§æå‡æ¨ç†æ•ˆç‡ã€‚
- **ä¼˜åŠ¿**ï¼š
  - æ¨ç†é€Ÿåº¦åª²ç¾ç”šè‡³è¶…è¶ŠResNet/VGG
  - ç»“æ„ç®€å•ï¼Œæ˜“äºéƒ¨ç½²
  - æ”¯æŒå¤šç§ç¡¬ä»¶å¹³å°
- **è¯¦ç»†è§£è¯»**ï¼šå¯å‚è€ƒä½œè€…çŸ¥ä¹æ–‡ç«  [ã€ŠRepVGGï¼šç»“æ„é‡å‚æ•°åŒ–å®‡å®™çš„èµ·ç‚¹ã€‹](https://zhuanlan.zhihu.com/p/344324470)

---

## ç»“æ„é‡å‚æ•°åŒ–å®‡å®™ç®€è¿°
- **èµ·ç‚¹ï¼šRepVGG**
- **æ ¸å¿ƒæ€æƒ³**ï¼šè®­ç»ƒæ—¶ç”¨å¤šåˆ†æ”¯ç»“æ„æå‡æ€§èƒ½ï¼Œæ¨ç†æ—¶èåˆä¸ºå•åˆ†æ”¯ï¼Œå…¼é¡¾è¡¨è¾¾åŠ›ä¸æ¨ç†æ•ˆç‡ã€‚
- **åç»­å‘å±•**ï¼šRepResNetã€YOLOv6/YOLOv9ç­‰ä¼—å¤šæ¨¡å‹å‡é‡‡ç”¨ç»“æ„é‡å‚æ•°åŒ–æ€æƒ³ã€ä½œè€…åç»­è¿˜æœ‰RepMLPã€RepLKNetç­‰ä¸€ç³»åˆ—å·¥ä½œã€‚
- **æ„ä¹‰**ï¼šæå¤§æ¨åŠ¨äº†æ·±åº¦å­¦ä¹ æ¨¡å‹çš„å·¥ä¸šéƒ¨ç½²å’Œé«˜æ•ˆæ¨ç†ã€‚

---

## è‡´è°¢
- æœ¬é¡¹ç›®å‚è€ƒäº† [RepVGG](https://github.com/DingXiaoH/RepVGG) å®˜æ–¹å®ç°åŠçŸ¥ä¹ç­‰ç¤¾åŒºèµ„æ–™ï¼Œæ„Ÿè°¢å¼€æºç¤¾åŒºçš„è´¡çŒ®ï¼

---

> **å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿ issue æˆ– PRï¼**
